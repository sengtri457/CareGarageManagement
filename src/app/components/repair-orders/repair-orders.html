<!-- Repair Order Wizard -->
<div class="container-fluid p-4">
    <div class="tools">
        <div class="wrapper-colors">
            <div class="circle">
                <span class="red box"></span>
            </div>
            <div class="circle">
                <span class="yellow box"></span>
            </div>
            <div class="circle">
                <span class="green box"></span>
            </div>
        </div>s
    </div>
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">Repair Order Wizard</h3>

            <!-- Progress Indicator -->
            <div class="progress mt-3" style="height: 8px;">
                <div class="progress-bar" [style.width.%]="(step / MAX_STEPS) * 100"></div>
            </div>

            <!-- Step Indicators -->
            <div class="d-flex justify-content-between mt-2">
                <span class="badge" [class]="step >= 1 ? 'bg-primary' : 'bg-secondary'">Customer</span>
                <span class="badge" [class]="step >= 2 ? 'bg-primary' : 'bg-secondary'">Vehicle</span>
                <span class="badge" [class]="step >= 3 ? 'bg-primary' : 'bg-secondary'">Services</span>
                <span class="badge" [class]="step >= 4 ? 'bg-primary' : 'bg-secondary'">Parts</span>
                <span class="badge" [class]="step >= 5 ? 'bg-primary' : 'bg-secondary'">Review</span>
            </div>
        </div>

        <div class="card-body">
            <!-- Loading Spinner -->
            <div *ngIf="loading.customers || loading.services || loading.parts || loading.mechanics"
                class="text-center p-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading data...</p>
            </div>

            <!-- Step 1: Select Customer -->
            <div *ngIf="step === 1" class="step-content">
                <h5 class="mb-3">
                    <i class="bi bi-person"></i> Step 1: Select Customer
                </h5>

                <div class="mb-3">
                    <label for="customerSelect" class="form-label">Customer *</label>
                    <select id="customerSelect" class="form-select" [(ngModel)]="order.customerId" name="customerId"
                        (change)="onCustomerChange()" [disabled]="loading.customers">
                        <option [ngValue]="null">Select Customer</option>
                        <option *ngFor="let c of customers" [ngValue]="c._id">
                            {{c.firstName || 'N/A'}} {{c.lastName || 'N/A'}}
                            <span *ngIf="c.phone">({{c.phone}})</span>
                        </option>
                    </select>

                </div>

                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary" [disabled]="!canProceedToNextStep" (click)="nextStep()">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>


            </div>

            <!-- Step 2: Select Vehicle -->
            <div *ngIf="step === 2" class="step-content">
                <h5 class="mb-3">
                    <i class="bi bi-car-front"></i> Step 2: Select Vehicle
                </h5>

                <!-- Customer Info Display -->
                <div class="alert alert-info mb-3" *ngIf="selectedCustomer">
                    <strong>Customer:</strong> {{selectedCustomer.firstName}} {{selectedCustomer.lastName}}
                    <span *ngIf="selectedCustomer.phone"> - {{selectedCustomer.phone}}</span>
                </div>

                <div class="mb-3">
                    <label for="vehicleSelect" class="form-label">Vehicle *</label>
                    <select id="vehicleSelect" class="form-select" [(ngModel)]="order.vehicleId" name="vehicleId"
                        [disabled]="loading.vehicles || vehicles.length === 0">
                        <option value="">Select Vehicle</option>
                        <option *ngFor="let v of vehicles" [value]="v._id">
                            {{v.licensePlate || 'No Plate'}} - {{v.make}} {{v.model}} ({{v.year}})
                        </option>
                    </select>

                    <!-- No vehicles message -->
                    <div *ngIf="vehicles.length === 0 && !loading.vehicles && order.customerId" class="text-muted mt-2">
                        No vehicles found for this customer.
                    </div>

                    <!-- Loading vehicles -->
                    <div *ngIf="loading.vehicles" class="text-muted mt-2">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Loading vehicles...
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-secondary" (click)="prevStep()">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" [disabled]="!canProceedToNextStep" (click)="nextStep()">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Select Services -->
            <div *ngIf="step === 3" class="step-content">
                <h5 class="mb-3">
                    <i class="bi bi-tools"></i> Step 3: Select Services
                </h5>

                <!-- Vehicle Info Display -->
                <div class="alert alert-info mb-3" *ngIf="selectedVehicle">
                    <strong>Vehicle:</strong> {{selectedVehicle.make}} {{selectedVehicle.model}}
                    ({{selectedVehicle.year}})
                    <span *ngIf="selectedVehicle.licensePlate"> - {{selectedVehicle.licensePlate}}</span>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3">Available Services *</h6>
                        <div class="service-selection">
                            <div *ngFor="let s of services" class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="form-check d-flex align-items-center">
                                        <input type="checkbox" class="form-check-input me-3" [id]="'service-' + s._id"
                                            [checked]="isServiceSelected(s._id)" (change)="onServiceToggle(s._id)">
                                        <label class="form-check-label flex-grow-1" [for]="'service-' + s._id">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{s.name}}</strong>
                                                    <div class="text-muted small" *ngIf="s.description">
                                                        {{s.description}}</div>
                                                </div>
                                                <span class="badge bg-primary">{{formatCurrency(s.basePrice)}}</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="services.length === 0" class="text-muted">
                            No services available.
                        </div>
                    </div>

                    <!-- Selected Services Summary -->
                    <div class="col-md-4">
                        <h6>Selected Services</h6>
                        <div class="card">
                            <div class="card-body">
                                <div *ngIf="selectedServicesList.length === 0" class="text-muted">
                                    No services selected
                                </div>
                                <div *ngFor="let service of selectedServicesList"
                                    class="d-flex justify-content-between mb-2">
                                    <span>{{service.name}}</span>
                                    <span>{{formatCurrency(service.basePrice)}}</span>
                                </div>
                                <hr *ngIf="selectedServicesList.length > 0">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Service Total:</span>
                                    <span>{{formatCurrency(getServiceTotal())}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary" (click)="prevStep()">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" [disabled]="!canProceedToNextStep" (click)="nextStep()">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Select Parts -->
            <div *ngIf="step === 4" class="step-content">
                <h5 class="mb-3">
                    <i class="bi bi-gear"></i> Step 4: Select Parts (Optional)
                </h5>

                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-3">Available Parts</h6>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="50">Select</th>
                                        <th>Part</th>
                                        <th>SKU</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Qty</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (p of prtInvern; track $index) {
                                    <tr [class]="p.availableQty === 0 ? 'table-secondary' : ''">
                                        <td>
                                            <input type="checkbox" class="form-check-input"
                                                [checked]="isPartSelected(p._id)" [disabled]="p.availableQty === 0"
                                                (change)="onPartToggle(p._id)">
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{p.name}}</strong>
                                                <div class="text-muted small">{{p.location}}</div>
                                                <div class="text-muted small" *ngIf="p.batchNo">Batch: {{p.batchNo}}
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{p.sku}}</td>
                                        <td>{{formatCurrency(p.unitPrice)}}</td>
                                        <td>
                                            <span
                                                [class]="p.availableQty === 0 ? 'text-danger' : p.availableQty <= 10 ? 'text-warning' : 'text-success'">
                                                {{p.qtyStock}} {{p.unit}}
                                            </span>
                                            <span *ngIf="p.availableQty === 0" class="badge bg-danger ms-1">Out of
                                                Stock</span>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control" style="width:80px"
                                                [(ngModel)]="partQty[p._id]"
                                                [disabled]="!isPartSelected(p._id) || p.availableQty === 0" min="1"
                                                [max]="p.availableQty" (ngModelChange)="onPartQtyChange(p._id)">

                                        </td>
                                        <td>
                                            <span *ngIf="isPartSelected(p._id)">
                                                {{formatCurrency(p.unitPrice * getPartQuantity(p._id))}}
                                            </span>
                                        </td>
                                    </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div *ngIf="parts.length === 0" class="text-muted">
                            No parts available.
                        </div>
                    </div>

                    <!-- Selected Parts Summary -->
                    <div class="col-md-4">
                        <h6>Selected Parts</h6>
                        <div class="card">
                            <div class="card-body">
                                <div *ngIf="selectedPartsList.length === 0" class="text-muted">
                                    No parts selected
                                </div>
                                <div *ngFor="let part of selectedPartsList" class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>{{part.name}}</span>
                                        <span>{{getPartQuantity(part._id)}} ×
                                            {{formatCurrency(part.unitPrice)}}</span>
                                    </div>
                                    <div class="text-muted small">{{part.sku}} - {{part.location}}</div>
                                </div>
                                <hr *ngIf="selectedPartsList.length > 0">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Parts Total:</span>
                                    <span>{{formatCurrency(getPartsTotal())}}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Assignments -->
                        <div class="mt-3">
                            <h6>Additional Assignments</h6>
                            <div class="mb-2">
                                <label class="form-label">Machine</label>
                                <select class="form-select" [(ngModel)]="selectedMachineId"
                                    (ngModelChange)="onMachineSelect($event)">
                                    <option [ngValue]="null">-- Select Machine --</option>
                                    <option *ngFor="let mach of machines" [ngValue]="mach._id">
                                        {{ mach.name }} ({{ mach.serialNo }})
                                    </option>
                                </select>

                            </div>

                            <div class="mb-2">
                                <label class="form-label">Mechanic</label>
                                <select class="form-select" [(ngModel)]="selectedMechanicId"
                                    (ngModelChange)="onMechanicSelect($event)">
                                    <option [ngValue]="null">-- Select Mechanic --</option>
                                    <option *ngFor="let m of mechanics" [ngValue]="m._id">
                                        {{ m.firstName }} {{ m.lastName }} ({{ m.specialization || 'General' }})
                                    </option>
                                </select>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary" (click)="prevStep()">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" (click)="nextStep()">
                        Review Order <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 5: Review and Submit -->
            <div *ngIf="step === 5" class="step-content">
                <h5 class="mb-3">
                    <i class="bi bi-check2-square"></i> Step 5: Review Order
                </h5>

                <div class="row">
                    <div class="col-md-8">
                        <!-- Customer & Vehicle Summary -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Customer & Vehicle</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Customer:</strong><br>
                                        {{selectedCustomer?.firstName}} {{selectedCustomer?.lastName}}<br>
                                        <span *ngIf="selectedCustomer?.phone">{{selectedCustomer?.phone}}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Vehicle:</strong><br>
                                        {{selectedVehicle?.make}} {{selectedVehicle?.model}}
                                        ({{selectedVehicle?.year}})<br>
                                        <span
                                            *ngIf="selectedVehicle?.licensePlate">{{selectedVehicle?.licensePlate}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services Summary -->
                        <div class="card mb-3" *ngIf="selectedServicesList.length > 0">
                            <div class="card-header">
                                <h6 class="mb-0">Services</h6>
                            </div>
                            <div class="card-body">
                                <div *ngFor="let service of selectedServicesList"
                                    class="d-flex justify-content-between mb-1">
                                    <span>{{service.name}}</span>
                                    <span>{{formatCurrency(service.basePrice)}}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Parts Summary -->
                        <div class="card mb-3" *ngIf="selectedPartsList.length > 0">
                            <div class="card-header">
                                <h6 class="mb-0">Parts</h6>
                            </div>
                            <div class="card-body">
                                <div *ngFor="let part of selectedPartsList" class="d-flex justify-content-between mb-1">
                                    <span>{{part.name}} ({{getPartQuantity(part._id)}} {{part.unit}})</span>
                                    <span>{{formatCurrency(part.unitPrice * getPartQuantity(part._id))}}</span>
                                </div>
                            </div>
                        </div>
                        <!-- Mechanic Summary -->
                        <div class="card mb-3" *ngIf="selectedParts">
                            <div class="card-header">
                                <h6 class="mb-0">Mechanic</h6>
                            </div>
                            <div class="card-body">
                                <span>
                                    {{selectedMechanic?.firstName}}{{selectedMechanic?.lastName}}<br>
                                </span>
                            </div>
                        </div>
                        <!-- Machine Summary -->
                        <div class="card mb-3" *ngIf="selectedParts">
                            <div class="card-header">
                                <h6 class="mb-0">Machines</h6>
                            </div>
                            <div class="card-body">
                                <span>
                                    {{selectedMachine?.name}}<br>
                                </span>
                            </div>
                        </div>


                        <!-- Notes -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Notes</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" rows="3" [(ngModel)]="order.notes"
                                    placeholder="Add any additional notes for this repair order..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Order Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Services:</span>
                                    <span>{{formatCurrency(getServiceTotal())}}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Parts:</span>
                                    <span>{{formatCurrency(getPartsTotal())}}</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span>{{formatCurrency(getGrandTotal())}}</span>
                                </div>

                                <!-- Order Details -->
                                <hr>
                                <div class="small text-muted">
                                    <div><strong>Date:</strong> {{order.date | date:'medium'}}</div>
                                    <div><strong>Status:</strong> {{order.status | titlecase}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary" (click)="prevStep()">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-success btn-lg" [disabled]="loading.submitting || !isFormValid"
                        (click)="submitOrder()">
                        <span *ngIf="loading.submitting" class="spinner-border spinner-border-sm me-2"></span>
                        <i *ngIf="!loading.submitting" class="bi bi-check-circle me-2"></i>
                        {{loading.submitting ? 'Creating Order...' : 'Create Repair Order'}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
@if(step===1){
<app-repairorder-list />
}